LIFEGAME_CSS[] =
  index/css/color/classic.css
  index/css/color/skyblue.css
  index/css/color/hacker.css
  index/css/color/pop.css
  index/css/figure/circle.css
  index/css/figure/rectangle.css
  index/css/size/max.css
  index/css/size/mid.css
  index/css/size/min.css
  index/css/outline/no-outline.css
  index/css/outline/solid.css

LIFEGAME_CSS_PATTERNS[] = 
  classic.css max.css rectangle.css no-outline.css
  classic.css max.css circle.css no-outline.css
  classic.css mid.css circle.css no-outline.css

  skyblue.css max.css rectangle.css solid.css
  skyblue.css max.css rectangle.css no-outline.css

  hacker.css max.css rectangle.css solid.css
  hacker.css max.css rectangle.css no-outline.css
  hacker.css mid.css rectangle.css no-outline.css
  hacker.css min.css rectangle.css no-outline.css

  pop.css mid.css circle.css no-outline.css
  pop.css min.css circle.css no-outline.css

LIFEGAME_INIT[] =
  index/lifegame-init/nebula
  index/lifegame-init/pulsar
  index/lifegame-init/pentadecathlon
  index/lifegame-init/r-pentomino1
  index/lifegame-init/r-pentomino2
  index/lifegame-init/r-pentomino3
  index/lifegame-init/r-pentomino4

$(BUILDDIR)/index.html: $(BUILDDIR) main.html index.html.erb
    env X=30 Y=30 erb index.html.erb > $(BUILDDIR)/index.html

$(BUILDDIR)/css/main.css: $(BUILDDIR)/css main.css
    cp main.css $(BUILDDIR)/css/main.css

$(BUILDDIR)/css/lifegame.css: $(BUILDDIR)/css lifegame.css.erb
    env X=30 Y=30 erb lifegame.css.erb > $(BUILDDIR)/css/lifegame.css

$(BUILDDIR)/css: $(LIFEGAME_CSS)
    mkdir -p $(BUILDDIR)/css

    foreach (css, $(LIFEGAME_CSS))
        cp $(css) $(BUILDDIR)/css

$(BUILDDIR)/usercss: $(LIFEGAME_CSS) usercss.erb $(LIFEGAME_CSS)
    mkdir -p $(BUILDDIR)/usercss
    foreach (css, $(LIFEGAME_CSS))
        env CSS=$(css) erb usercss.erb > $(BUILDDIR)/usercss/$(basename $(css))

$(BUILDDIR)/coffee/index.coffee: $(BUILDDIR)/coffee index.coffee.erb $(LIFEGAME_INIT) $(LIFEGAME_CSS)

  section:
    LIFEGAME_CSSES =

    foreach (csses, $(LIFEGAME_CSS_PATTERNS))
        LIFEGAME_CSSES += $(concat \,, $(csses))
        export

    env X=30 Y=30 \
        LIFEGAME_CSS=$(concat :, $(LIFEGAME_CSSES)) \
        LIFEGAME_INIT=$(concat :, $(LIFEGAME_INIT)) \
        erb index.coffee.erb > $(BUILDDIR)/coffee/index.coffee

$(BUILDDIR)/js/index.js: $(BUILDDIR)/js $(BUILDDIR)/coffee/index.coffee
    coffee -o $(BUILDDIR)/js -c $(BUILDDIR)/coffee/index.coffee

build: $(BUILDDIR)/index.html \
       $(BUILDDIR)/css/main.css \
       $(BUILDDIR)/css/lifegame.css \
       $(BUILDDIR)/css \
       $(BUILDDIR)/usercss \
       $(BUILDDIR)/js/index.js

clean: build
    rm $(BUILDDIR)/index.html
    rm $(BUILDDIR)/css/main.css
    rm $(BUILDDIR)/css/lifegame.css

    foreach (css, $(LIFEGAME_CSS))
      rm $(BUILDDIR)/css/$(basename $(css))
      rm $(BUILDDIR)/usercss/$(basename $(css))

    rmdir $(BUILDDIR)/usercss
    rm $(BUILDDIR)/js/index.js
    rm $(BUILDDIR)/coffee/index.coffee