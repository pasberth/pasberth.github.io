LIFEGAME_CSS[] =
  lifegame-ball.css
  lifegame-ring.css
  lifegame-classic.css
  lifegame-skyblue.css
  lifegame-hacker.css

$(BUILDDIR)/index.html: $(BUILDDIR) main.html index.html.erb
    env X=30 Y=30 erb index.html.erb > $(BUILDDIR)/index.html

$(BUILDDIR)/css/main.css: $(BUILDDIR)/css main.css
    cp main.css $(BUILDDIR)/css/main.css

$(BUILDDIR)/css/lifegame.css: $(BUILDDIR)/css lifegame.css.erb
    env X=30 Y=30 erb lifegame.css.erb > $(BUILDDIR)/css/lifegame.css

$(BUILDDIR)/css: $(LIFEGAME_CSS)
    mkdir -p $(BUILDDIR)/css

    foreach (css, $(LIFEGAME_CSS))
        cp $(css) $(BUILDDIR)/css

$(BUILDDIR)/usercss: $(LIFEGAME_CSS) usercss.erb
    mkdir -p $(BUILDDIR)/usercss
    foreach (css, $(LIFEGAME_CSS))
        env CSS=$(css) erb usercss.erb > $(BUILDDIR)/usercss/$(css)

$(BUILDDIR)/coffee/index.coffee: $(BUILDDIR)/coffee index.coffee.erb
    env X=30 Y=30 LIFEGAME_CSS=$(concat :, $(LIFEGAME_CSS)) erb index.coffee.erb > $(BUILDDIR)/coffee/index.coffee

$(BUILDDIR)/js/index.js: $(BUILDDIR)/js $(BUILDDIR)/coffee/index.coffee
    coffee -o $(BUILDDIR)/js -c $(BUILDDIR)/coffee/index.coffee

build: $(BUILDDIR)/index.html \
       $(BUILDDIR)/css/main.css \
       $(BUILDDIR)/css/lifegame.css \
       $(BUILDDIR)/css \
       $(BUILDDIR)/usercss \
       $(BUILDDIR)/js/index.js

clean: build
    rm $(BUILDDIR)/index.html
    rm $(BUILDDIR)/css/main.css
    rm $(BUILDDIR)/css/lifegame.css

    foreach (css, $(LIFEGAME_CSS))
      rm $(BUILDDIR)/css/$(css)
      rm $(BUILDDIR)/usercss/$(css)

    rmdir $(BUILDDIR)/usercss
    rm $(BUILDDIR)/js/index.js
    rm $(BUILDDIR)/coffee/index.coffee