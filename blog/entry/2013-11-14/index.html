<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    
      <title>js_of_ocaml + ocamllex + menhir で S式をパースする</title>
    

    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
</head>
<body>

    <div class="body">
        
  <div class="section" id="js-of-ocaml-ocamllex-menhir-s">
<h1>js_of_ocaml + ocamllex + menhir で S式をパースする<a class="headerlink" href="#js-of-ocaml-ocamllex-menhir-s" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="../2013-11-09/index.html"><em>menhir で S式をパースする</em></a> で menhir を使った．これは， OCaml だ．
<a class="reference internal" href="../2013-11-12/index.html"><em>js_of_ocaml で hello world</em></a> で js_of_ocaml を使った．これは， OCaml を
JavaScript にコンパイルできる．では， JavaScript で menhir を使うことも，
できるはずだ．そういうわけで，実際に試してみた．
使用するコードは， <a class="reference internal" href="../2013-11-09/index.html"><em>menhir で S式をパースする</em></a> で使ったものと，
JavaScript のエントリーポイントからパーサを呼び出すための main.ml</p>
<ul>
<li><p class="first">main.ml</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">open</span> <span class="nc">Js</span>
<span class="k">open</span> <span class="nc">Firebug</span>

<span class="c">(* JS の文字列としてこういう入力があったとする *)</span>
<span class="k">let</span> <span class="n">js_str_test1</span> <span class="o">=</span> <span class="kt">string</span> <span class="s2">&quot;(a b c)&quot;</span>
<span class="k">let</span> <span class="n">js_str_test2</span> <span class="o">=</span> <span class="kt">string</span> <span class="s2">&quot;(define (S x y z) (x z (y z)))&quot;</span>

<span class="c">(* JS の文字列から OCaml の文字列に戻す *)</span>
<span class="k">let</span> <span class="n">ml_str_test1</span> <span class="o">=</span> <span class="n">to_string</span> <span class="n">js_str_test1</span>
<span class="k">let</span> <span class="n">ml_str_test2</span> <span class="o">=</span> <span class="n">to_string</span> <span class="n">js_str_test2</span>

<span class="c">(* AST を OCaml の文字列にする *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">spp</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Symbol</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>  <span class="o">-&gt;</span> <span class="n">s</span>
  <span class="o">|</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;(%s.%s)&quot;</span> <span class="o">(</span><span class="n">spp</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">spp</span> <span class="n">y</span><span class="o">)</span>
  <span class="o">|</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Nil</span>        <span class="o">-&gt;</span> <span class="s2">&quot;()&quot;</span>

<span class="c">(* AST を JS の文字列にする *)</span>
<span class="k">let</span> <span class="n">js_spp</span> <span class="n">x</span> <span class="o">=</span> <span class="kt">string</span> <span class="o">(</span><span class="n">spp</span> <span class="n">x</span><span class="o">)</span>

<span class="k">let</span> <span class="n">js_pp</span> <span class="n">x</span> <span class="o">=</span> <span class="n">console</span><span class="o">##</span><span class="n">log</span> <span class="o">(</span><span class="n">js_spp</span> <span class="n">x</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> 
  <span class="k">let</span> <span class="n">lexbuf</span> <span class="o">=</span> <span class="nn">Lexing</span><span class="p">.</span><span class="n">from_string</span> <span class="n">ml_str_test1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sexp</span> <span class="o">=</span> <span class="nn">Parser</span><span class="p">.</span><span class="n">main</span> <span class="nn">Lexer</span><span class="p">.</span><span class="n">token</span> <span class="n">lexbuf</span> <span class="k">in</span>
  <span class="n">js_pp</span> <span class="n">sexp</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> 
  <span class="k">let</span> <span class="n">lexbuf</span> <span class="o">=</span> <span class="nn">Lexing</span><span class="p">.</span><span class="n">from_string</span> <span class="n">ml_str_test2</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sexp</span> <span class="o">=</span> <span class="nn">Parser</span><span class="p">.</span><span class="n">main</span> <span class="nn">Lexer</span><span class="p">.</span><span class="n">token</span> <span class="n">lexbuf</span> <span class="k">in</span>
  <span class="n">js_pp</span> <span class="n">sexp</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">sexp.ml</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">type</span> <span class="n">t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Symbol</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="nc">Cons</span>   <span class="k">of</span> <span class="o">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">t</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Nil</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">lexer.mll</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">{</span>
<span class="k">open</span> <span class="nc">Parser</span>
<span class="o">}</span>

<span class="k">let</span> <span class="n">spaces</span>   <span class="o">=</span> <span class="o">[</span><span class="sc">&#39; &#39;</span> <span class="sc">&#39;\t&#39;</span> <span class="sc">&#39;\r&#39;</span> <span class="sc">&#39;\n&#39;</span><span class="o">]+</span>
<span class="k">let</span> <span class="n">symbol</span>  <span class="o">=</span> <span class="o">[^</span> <span class="sc">&#39;(&#39;</span> <span class="sc">&#39;)&#39;</span> <span class="sc">&#39;.&#39;</span> <span class="sc">&#39; &#39;</span> <span class="sc">&#39;\t&#39;</span> <span class="sc">&#39;\r&#39;</span> <span class="sc">&#39;\n&#39;</span><span class="o">]+</span>

<span class="n">rule</span> <span class="n">token</span> <span class="o">=</span> <span class="n">parse</span>
    <span class="n">spaces</span>  <span class="o">{</span> <span class="n">token</span> <span class="n">lexbuf</span> <span class="o">}</span>
  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">{</span> <span class="nc">SYMBOL</span><span class="o">(</span><span class="nn">Lexing</span><span class="p">.</span><span class="n">lexeme</span> <span class="n">lexbuf</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;(&#39;</span>     <span class="o">{</span> <span class="nc">OPEN</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;.&#39;</span>     <span class="o">{</span> <span class="nc">DOT</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;)&#39;</span>     <span class="o">{</span> <span class="nc">CLOSE</span> <span class="o">}</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">parser.mly</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">%{</span>
<span class="o">%}</span>

<span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="nc">SYMBOL</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">OPEN</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">DOT</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">CLOSE</span>
<span class="o">%</span><span class="n">start</span> <span class="n">main</span>
<span class="o">%</span><span class="k">type</span> <span class="o">&lt;</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span><span class="o">&gt;</span> <span class="n">main</span>

<span class="o">%%</span>

<span class="n">main</span><span class="o">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sexp</span> <span class="o">{</span> <span class="n">x</span> <span class="o">}</span>

<span class="n">sexp</span><span class="o">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nc">SYMBOL</span>                              <span class="o">{</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Symbol</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">OPEN</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">sexp</span><span class="o">;</span> <span class="nc">DOT</span><span class="o">;</span> <span class="n">y</span> <span class="o">=</span> <span class="n">sexp</span><span class="o">;</span> <span class="nc">CLOSE</span>    <span class="o">{</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">OPEN</span><span class="o">;</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">sexp</span><span class="o">*;</span> <span class="nc">CLOSE</span>                 <span class="o">{</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">))</span> <span class="n">xs</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Nil</span> <span class="o">}</span>

<span class="o">%%</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
<p>これらを使用して，次のようなコマンドでコンパイルする．</p>
<div class="code sh highlight-python"><pre>menhir parser.ml
ocamllex lexer.ml

ocamlc -c sexp.ml
ocamlc -c parser.ml
ocamlc -c lexer.ml
ocamlfind ocamlc -syntax camlp4o -package lwt,js_of_ocaml.syntax -c main.ml
ocamlfind ocamlc -package lwt,js_of_ocaml -linkpkg -o main.byte parser.cmo lexer.cmo main.cmo
js_of_ocaml main.byte</pre>
</div>
<p>そしてつくられる main.js を実行してみると…期待通り動いた！！
すごい！！
OCaml はサイコー</p>
</div>


    </div>

</body>
</html>