<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    
      <title>C++ テンプレートメタプログラミング</title>
    

    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
</head>
<body>

    <div class="body">
        
  <div class="section" id="c">
<h1>C++ テンプレートメタプログラミング<a class="headerlink" href="#c" title="Permalink to this headline">¶</a></h1>
<p>C++ テンプレートメタプログラミングという本を読んでいろいろ勉強していた．
ちょっと知ったことをまとめようと思う．</p>
<p>まず， C++ テンプレートメタプログラミングではクラステンプレートのことを
メタ関数という．クラステンプレートというのは，</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="n">args</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">function_name</span>
<span class="p">{</span>
    <span class="c1">// body</span>
<span class="p">};</span>
</pre></div>
</div>
<p>のような形をした struct ということである． C++ ではテンプレートの引数として
型だけでなく値も渡せる．さらに，テンプレートの特殊化は値によってパターンマッチ
しているように振る舞う．だから，</p>
<ul class="simple">
<li>テンプレートの引数 = 関数の引数</li>
<li>テンプレートの特殊化 = 分岐</li>
<li>構造体のメンバ = 戻り値</li>
</ul>
<p>のようにして，コンパイル時にプログラミングできるというわけである．
たとえば，コンパイル時に足し算をするには次のように書く．</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">result</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">plus_type</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">int</span> <span class="n">value_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">plus</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">plus_type</span><span class="o">&lt;</span><span class="n">n</span> <span class="o">+</span> <span class="n">m</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>引数のないメタ関数は，単なる構造体として書く．たとえば，</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">struct</span> <span class="n">nullary_metafunction_type</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">int</span> <span class="n">value_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* nullary_metafunction :: Int</span>
<span class="cm"> * nullary_metafunction = 42</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nullary_metafunction</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">nullary_metafunction_type</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>多値を戻す関数を書くこともできる．しかも，見ようによれば
キーワードで戻している．ちょうど JavaScript で <tt class="docutils literal"><span class="pre">return</span> <span class="pre">{</span> <span class="pre">a:</span> <span class="pre">x,</span> <span class="pre">b:</span> <span class="pre">y</span> <span class="pre">}</span></tt> みたいに
するようだ．</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">n_</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m_</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">multiple_values_type</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n_</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m_</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">int</span> <span class="n">value_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">multiple_values</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">multiple_values_type</span><span class="o">&lt;</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>部分適用などは MPL を使えばできるらしい．</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">typedef</span> <span class="n">mpl</span><span class="o">::</span><span class="n">plus</span><span class="o">&lt;</span><span class="n">_1</span><span class="p">,</span> <span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">inc</span><span class="p">;</span>
</pre></div>
</div>
</div>


    </div>

</body>
</html>