<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    
      <title>menhir で S式をパースする</title>
    

    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
</head>
<body>

    <div class="body">
        
  <div class="section" id="menhir-s">
<h1>menhir で S式をパースする<a class="headerlink" href="#menhir-s" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="../2013-10-25/index.html"><em>ocamlyacc と ocamllex で S式をパースする</em></a> を書いている最中，
<a class="reference external" href="http://cristal.inria.fr/~fpottier/menhir">menhir</a> というツールがあることを知った．
menhir は， ocamlyacc と似たツールで，パーサジェネレータだ．パーサを BNF のように書くと，
OCaml のコードを出力してくれる．せっかくだから，試してみることにした．</p>
<div class="section" id="id1">
<h2>インストール<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>opam を使用して，次のようにインストールできる．</p>
<div class="highlight-sh"><div class="highlight"><pre>opam install menhir
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>使用法<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>ocamlyacc と同じ要領で parser.mly をつくり，次のようなコマンドで parser.ml を
生成できる．</p>
<div class="highlight-sh"><div class="highlight"><pre>menhir parser.mly
</pre></div>
</div>
</div>
<div class="section" id="omake">
<h2>OMake から使用する<a class="headerlink" href="#omake" title="Permalink to this headline">¶</a></h2>
<p>ocamlyacc と同じ要領で parser.mly をつくり，次のように OMakefile に記述すればよい．</p>
<div class="highlight-ocaml"><div class="highlight"><pre><span class="nc">OCAMLPACKS</span><span class="bp">[]</span> <span class="o">=</span>
  <span class="n">menhir</span>

<span class="nc">OCAMLYACC</span> <span class="o">=</span> <span class="n">menhir</span>

<span class="nc">OCamlGeneratedFiles</span><span class="o">(</span><span class="n">parser</span><span class="o">.</span><span class="n">ml</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>menhir の特徴<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>menhir は ocamlyacc と 90% 互換らしい．じっさい， <a class="reference internal" href="../2013-10-25/index.html"><em>ocamlyacc と ocamllex で S式をパースする</em></a> に
載せている parser.mly がそのまま通る．</li>
<li>ocamlyacc は LALR(1) の文法しか受け付けないが， menhir は LR(1) の文法を受け付ける．</li>
<li>正規表現の <tt class="docutils literal"><span class="pre">?</span></tt>, <tt class="docutils literal"><span class="pre">+</span></tt>, <tt class="docutils literal"><span class="pre">*</span></tt> のような表現ができる</li>
<li>ocamlyacc では <tt class="code highlight ocaml docutils literal"><span class="name class"><span class="pre">X</span></span> <span class="operator"><span class="pre">{</span></span> <span class="operator"><span class="pre">$</span></span><span class="literal number integer"><span class="pre">1</span></span> <span class="operator"><span class="pre">}</span></span></tt> のようにしてマッチングしたトークンを参照するが，
menhir では名前付きで <tt class="code highlight ocaml docutils literal"><span class="name"><span class="pre">x</span></span> <span class="operator"><span class="pre">=</span></span> <span class="name class"><span class="pre">X</span></span> <span class="operator"><span class="pre">{</span></span> <span class="name"><span class="pre">x</span></span> <span class="operator"><span class="pre">}</span></span></tt> のような表現ができる</li>
<li>他多数…くわしくは， <a class="reference external" href="http://cristal.inria.fr/~fpottier/menhir/manual.pdf">manual</a>
を読んでみてほしい．</li>
</ul>
</div>
<div class="section" id="s">
<h2>S式の実装<a class="headerlink" href="#s" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../2013-10-25/index.html"><em>ocamlyacc と ocamllex で S式をパースする</em></a> のコードはそのまま通るので流用できるのだけど，
せっかくなので menhir の機能を使って書いてみた．</p>
<ul>
<li><p class="first">sexp.ml:</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">type</span> <span class="n">t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Symbol</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="nc">Cons</span>   <span class="k">of</span> <span class="o">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">t</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Nil</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">lexer.mll:</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">{</span>
<span class="k">open</span> <span class="nc">Parser</span>
<span class="o">}</span>

<span class="k">let</span> <span class="n">spaces</span>   <span class="o">=</span> <span class="o">[</span><span class="sc">&#39; &#39;</span> <span class="sc">&#39;\t&#39;</span> <span class="sc">&#39;\r&#39;</span> <span class="sc">&#39;\n&#39;</span><span class="o">]+</span>
<span class="k">let</span> <span class="n">symbol</span>  <span class="o">=</span> <span class="o">[^</span> <span class="sc">&#39;(&#39;</span> <span class="sc">&#39;)&#39;</span> <span class="sc">&#39;.&#39;</span> <span class="sc">&#39; &#39;</span> <span class="sc">&#39;\t&#39;</span> <span class="sc">&#39;\r&#39;</span> <span class="sc">&#39;\n&#39;</span><span class="o">]+</span>

<span class="n">rule</span> <span class="n">token</span> <span class="o">=</span> <span class="n">parse</span>
    <span class="n">spaces</span>  <span class="o">{</span> <span class="n">token</span> <span class="n">lexbuf</span> <span class="o">}</span>
  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">{</span> <span class="nc">SYMBOL</span><span class="o">(</span><span class="nn">Lexing</span><span class="p">.</span><span class="n">lexeme</span> <span class="n">lexbuf</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;(&#39;</span>     <span class="o">{</span> <span class="nc">OPEN</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;.&#39;</span>     <span class="o">{</span> <span class="nc">DOT</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;)&#39;</span>     <span class="o">{</span> <span class="nc">CLOSE</span> <span class="o">}</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">parser.mly:</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">%{</span>
<span class="o">%}</span>

<span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="nc">SYMBOL</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">OPEN</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">DOT</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">CLOSE</span>
<span class="o">%</span><span class="n">start</span> <span class="n">main</span>
<span class="o">%</span><span class="k">type</span> <span class="o">&lt;</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span><span class="o">&gt;</span> <span class="n">main</span>

<span class="o">%%</span>

<span class="n">main</span><span class="o">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sexp</span> <span class="o">{</span> <span class="n">x</span> <span class="o">}</span>

<span class="n">sexp</span><span class="o">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nc">SYMBOL</span>                              <span class="o">{</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Symbol</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">OPEN</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">sexp</span><span class="o">;</span> <span class="nc">DOT</span><span class="o">;</span> <span class="n">y</span> <span class="o">=</span> <span class="n">sexp</span><span class="o">;</span> <span class="nc">CLOSE</span>    <span class="o">{</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">OPEN</span><span class="o">;</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">sexp</span><span class="o">*;</span> <span class="nc">CLOSE</span>                 <span class="o">{</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">))</span> <span class="n">xs</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Nil</span> <span class="o">}</span>

<span class="o">%%</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">main.ml</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">let</span> <span class="k">rec</span> <span class="n">spp</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Symbol</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>  <span class="o">-&gt;</span> <span class="n">s</span>
  <span class="o">|</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;(%s.%s)&quot;</span> <span class="o">(</span><span class="n">spp</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">spp</span> <span class="n">y</span><span class="o">)</span>
  <span class="o">|</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">Nil</span>        <span class="o">-&gt;</span> <span class="s2">&quot;()&quot;</span>

<span class="k">let</span> <span class="n">pp</span> <span class="n">x</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="n">spp</span> <span class="n">x</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> 
  <span class="k">let</span> <span class="n">lexbuf</span> <span class="o">=</span> <span class="nn">Lexing</span><span class="p">.</span><span class="n">from_channel</span> <span class="n">stdin</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sexp</span> <span class="o">=</span> <span class="nn">Parser</span><span class="p">.</span><span class="n">main</span> <span class="nn">Lexer</span><span class="p">.</span><span class="n">token</span> <span class="n">lexbuf</span> <span class="k">in</span>
  <span class="n">pp</span> <span class="n">sexp</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">OMakefile</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="nc">OCAMLPACKS</span><span class="bp">[]</span> <span class="o">=</span>
  <span class="n">menhir</span>

<span class="nc">OCAMLYACC</span> <span class="o">=</span> <span class="n">menhir</span>

<span class="nc">FILES</span><span class="bp">[]</span> <span class="o">=</span>
  <span class="n">main</span>
  <span class="n">sexp</span>
  <span class="n">parser</span>
  <span class="n">lexer</span>

<span class="nc">OCamlProgram</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="o">,</span> <span class="o">$(</span><span class="nc">FILES</span><span class="o">))</span>
<span class="nc">OCamlGeneratedFiles</span><span class="o">(</span><span class="n">parser</span><span class="o">.</span><span class="n">ml</span> <span class="n">lexer</span><span class="o">.</span><span class="n">ml</span><span class="o">)</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
</div>
</div>


    </div>

</body>
</html>