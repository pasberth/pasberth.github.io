<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    
      <title>OCaml から C の関数を呼ぶ</title>
    

    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
</head>
<body>

    <div class="body">
        
  <div class="section" id="ocaml-c">
<h1>OCaml から C の関数を呼ぶ<a class="headerlink" href="#ocaml-c" title="Permalink to this headline">¶</a></h1>
<p>OCaml の FFI の話．
<a class="reference external" href="http://www.geocities.jp/harddiskdive/ocaml-wrapping-c/ocaml-wrapping-c.html">C関数をラップしてOCamlに接続する方法 (How to wrap C functions to OCaml)</a> が
詳しかった．まず， OCaml のコードを書こう． <tt class="code highlight ocaml docutils literal"><span class="name"><span class="pre">c_print_int</span></span></tt> は，
まだ実装のない， C言語の関数のシグネチャだ． <tt class="code highlight ocaml docutils literal"><span class="name"><span class="pre">c_print_int</span></span></tt> は，
うまく実行されれば，引数の整数をそのまま表示する．このプログラムの唯一の仕事は，
その関数に <tt class="code highlight ocaml docutils literal"><span class="literal number integer"><span class="pre">42</span></span></tt> という値を渡して呼び出すことだ．それ以上は，
なにもしない．もし正しく実行されれば，端末に <tt class="code highlight ocaml docutils literal"><span class="literal number integer"><span class="pre">42</span></span></tt> と表示される
はずだ．</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">external</span> <span class="n">c_print_int</span><span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">=</span> <span class="s2">&quot;c_print_int_impl&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">c_print_int</span> <span class="mi">42</span>
</pre></div>
</td></tr></table></div>
<p>次に， C言語で次のような関数をつくる． <tt class="docutils literal"><span class="pre">c_print_int_impl</span></tt> は，
<tt class="code highlight ocaml docutils literal"><span class="name"><span class="pre">c_print_int</span></span></tt> の実装だ． <tt class="docutils literal"><span class="pre">printf</span></tt> を使用して整数を表示する．
たったそれだけのことしかしない．</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;caml/mlvalues.h&gt;</span>

<span class="n">CAMLprim</span> <span class="n">value</span>
<span class="nf">c_print_int_impl</span><span class="p">(</span><span class="n">value</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">Int_val</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Val_unit</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>さて，これをコンパイルする為の OMakefile は，次のようになる．</p>
<div class="highlight-none"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre>dllcallCFunctionFromOCaml.so: callCFunctionFromOCaml.c callCFunctionFromOCaml.o
  ocamlc -c callCFunctionFromOCaml.c
  ocamlmklib -o callCFunctionFromOCaml callCFunctionFromOCaml.o

callCFunctionFromOCaml: callCFunctionFromOCaml.ml dllcallCFunctionFromOCaml.so
  ocamlc -o callCFunctionFromOCaml -dllib dllcallCFunctionFromOCaml.so callCFunctionFromOCaml.ml
</pre></div>
</td></tr></table></div>
</div>


    </div>

</body>
</html>