<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    
      <title>継続の実装について</title>
    

    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
</head>
<body>

    <div class="body">
        
  <div class="section" id="id1">
<h1>継続の実装について<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>たとえば．</p>
<div class="highlight-scheme"><div class="highlight"><pre><span class="p">(</span><span class="k">define </span><span class="nv">cont</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">call/cc </span><span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">k</span><span class="p">)</span> <span class="p">(</span><span class="k">set! </span><span class="nv">cont</span> <span class="nv">k</span><span class="p">)</span> <span class="nv">x</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">f</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">42</span><span class="p">)</span>     <span class="c1">; =&gt; (+ 1 42) =&gt; 43</span>
<span class="p">(</span><span class="nf">cont</span> <span class="mi">2</span><span class="p">)</span>         <span class="c1">; =&gt; (+ 2 42) =&gt; 44</span>
<span class="p">(</span><span class="nf">cont</span> <span class="mi">3</span><span class="p">)</span>         <span class="c1">; =&gt; (+ 3 42) =&gt; 45</span>
</pre></div>
</div>
<p>こんな感じの継続がある．この継続をどう実装すればよいか．</p>
<p>まず，最初の <tt class="docutils literal"><span class="pre">(+</span> <span class="pre">(f</span> <span class="pre">1)</span> <span class="pre">42)</span></tt> に関して．ここで <tt class="docutils literal"><span class="pre">(f</span> <span class="pre">1)</span></tt> を呼んだとき，コールスタックは
こんな感じになっているはずだ:</p>
<div class="code highlight-python"><pre>[
  {
    stack: 42;
    code: +の実行;
  }
]</pre>
</div>
<p>そこで，これを丸ごとヒープにコピーする．これで継続オブジェクトkがつくれた．
kは， (k x) のようにして呼ぶと，さきほどコピーしたコールスタックをガンガンコールスタックに積む．
それから，もう一度，あたかも f が x を戻したかのように振る舞う．
<tt class="docutils literal"><span class="pre">(call/cc</span> <span class="pre">proc)</span></tt> 自体は，kを引数にprocを呼び出し，そのまま実行する．戻り値はそのまま戻る．
結果として， <tt class="docutils literal"><span class="pre">(+</span> <span class="pre">(f</span> <span class="pre">1)</span> <span class="pre">42)</span></tt> は 43 に評価される．
しかし，procはkをcontに割り当てているので，あとから呼び出すことができる．すると，
<tt class="docutils literal"><span class="pre">(cont</span> <span class="pre">2)</span></tt> は，あたかも <tt class="docutils literal"><span class="pre">(+</span> <span class="pre">2</span> <span class="pre">42)</span></tt> を評価したかのように振る舞う．
<tt class="docutils literal"><span class="pre">(cont</span> <span class="pre">3)</span></tt> も同じだ．</p>
<p>参考: <a class="reference external" href="http://ja.wikibooks.org/wiki/Scheme/%E7%B6%99%E7%B6%9A%E3%81%AE%E7%A8%AE%E9%A1%9E%E3%81%A8%E5%88%A9%E7%94%A8%E4%BE%8B#.E5.AE.9F.E8.A3.85.E4.BE.8B">Scheme/継続の種類と利用例</a></p>
</div>


    </div>

</body>
</html>