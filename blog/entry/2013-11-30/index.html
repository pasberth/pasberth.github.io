<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    
      <title>LLVM でラムダ計算のコンパイラつくった</title>
    

    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
</head>
<body>

    <div class="body">
        
  <div class="section" id="llvm">
<h1>LLVM でラムダ計算のコンパイラつくった<a class="headerlink" href="#llvm" title="Permalink to this headline">¶</a></h1>
<p>本格的に言語をつくる前に，練習として，ちょっとしたラムダ計算のコンパイラをつくってみようと
思った．それができなければ，本格的なコンパイラなど夢のまた夢だろう．そういうわけで，
OCaml と LLVM を使用して， ラムダ計算のコンパイラをつくった．</p>
<p>ラムダ計算のコンパイラを実装するということは，オリジナルの言語のコンパイラに，高階関数を
実装することに相当する．ラムダ計算のコンパイラが実装できれば，確かな自信をもって，オレオレ
言語に第一級の関数を仕様として盛り込めるわけだ．</p>
<p>言語として OCaml を使用した．関数型言語はサイコーだ．</p>
<p>まず，目標を決める．今回の目標は，次のような関数をコンパイルして，  C から呼び出せるように
することだ．なぜ C から呼び出せるようにするかというと， printf などを使用して，実際に
動作しているかを目で確認したいから，というのと， printf を言語内から呼び出すのは
ちょっとハードルが高いように思えるからだ．</p>
<ul>
<li><p class="first">ski.txt</p>
<div class="highlight-none"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre>S := \xyz.xz(yz)
K := \xy.x
I := SKK
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">C から呼び出すイメージ</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &quot;ski.h&quot;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">I</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span> <span class="c1">// 42 と表示される</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<p>まず，型を定義する． AST の型は次のようになる．</p>
<div class="highlight-ocaml"><div class="highlight"><pre><span class="k">type</span> <span class="n">ast</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Ref</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="nc">Lam</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="n">ast</span>
  <span class="o">|</span> <span class="nc">App</span> <span class="k">of</span> <span class="n">ast</span> <span class="o">*</span> <span class="n">ast</span>

<span class="k">type</span> <span class="n">stat</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Def</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="n">ast</span>
</pre></div>
</div>
<p>たとえば， <tt class="docutils literal"><span class="pre">K</span> <span class="pre">:=</span> <span class="pre">\xy.x</span></tt> なら， <tt class="docutils literal"><span class="pre">Def(&quot;K&quot;,</span> <span class="pre">Lam(&quot;x&quot;,</span> <span class="pre">Lam(&quot;y&quot;,</span> <span class="pre">Ref(&quot;x&quot;))))</span></tt>
のようになる．</p>
<p>次に，この AST のままだと少々抽象的すぎるので， AST のちょっと形を変えたものにして
機械が扱いやすいようにする．</p>
<div class="highlight-ocaml"><div class="highlight"><pre><span class="k">type</span> <span class="n">indexed_ast</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">IxRef</span>   <span class="k">of</span> <span class="kt">int</span>            <span class="c">(* Index of access to environment *)</span>
  <span class="o">|</span> <span class="nc">IxGRef</span>  <span class="k">of</span> <span class="kt">string</span>         <span class="c">(* External name reference *)</span>
  <span class="o">|</span> <span class="nc">IxLam</span>   <span class="k">of</span>    <span class="kt">int</span>         <span class="c">(* Id of anonymouse function *)</span>
                <span class="o">*</span> <span class="kt">int</span>         <span class="c">(* Index of store to environment *)</span>
                <span class="o">*</span> <span class="n">indexed_ast</span> <span class="c">(* Body of lambda abstraction *)</span>
  <span class="o">|</span> <span class="nc">IxApp</span>   <span class="k">of</span>    <span class="n">indexed_ast</span> <span class="o">*</span> <span class="n">indexed_ast</span>

<span class="k">type</span> <span class="n">indexed_stat</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">IxDef</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="n">indexed_ast</span>
</pre></div>
</div>
<p>たとえば， <tt class="docutils literal"><span class="pre">K</span> <span class="pre">:=</span> <span class="pre">\xy.x</span></tt> なら， <tt class="docutils literal"><span class="pre">IxDef(&quot;K&quot;,</span> <span class="pre">IxLam(n,</span> <span class="pre">0,</span> <span class="pre">IxLam(m,</span> <span class="pre">1,</span> <span class="pre">IxRef(0))))</span></tt>
のようになる． <tt class="docutils literal"><span class="pre">\xy.x</span></tt> をよく見ると， <tt class="docutils literal"><span class="pre">\01.0</span></tt> のようにしても
同じである事がわかる．だから，出現する順に数字に置き換える事で，配列のインデックスを指し示す
ようにできる． <tt class="docutils literal"><span class="pre">n</span></tt> とか <tt class="docutils literal"><span class="pre">m</span></tt> とか書いているのは，ラムダ抽象の id だ．
LLVM IR の表現に高階関数なんてものはないので，ラムダはすべて静的な関数に置き換える必要がある．
たとえば， <tt class="docutils literal"><span class="pre">\xy.x</span></tt> は <tt class="docutils literal"><span class="pre">\x.(\y.x)</span></tt> と同じで，ラムダの中でラムダが作られているけども，
LLVM IR の表現に直すときは，関数の中で関数をつくることはできないので，関数の外で定義されている
ように置き換える．そこで， まず， <tt class="docutils literal"><span class="pre">\x.(..)</span></tt> という外側のラムダの id を n，
<tt class="docutils literal"><span class="pre">...(\y.x)</span></tt> という内側のラムダの id を m ということにして，</p>
<div class="highlight-llvm"><div class="highlight"><pre><span class="k">define</span> <span class="kt">void</span> <span class="vg">@.anon_func.n</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">; .anon_func.m のクロージャをつくる処理</span>
<span class="p">}</span>

<span class="k">define</span> <span class="kt">void</span> <span class="vg">@.anon_func.m</span><span class="p">()</span> <span class="p">{..}</span>
</pre></div>
</div>
<p>のようにコンパイルするワケだ．</p>
<p>次に，パーサをつくる．パーサに関しては，一言も言及しなくてもよいだろう．
もしパーサに関して興味があるなら別の記事を読んでみてほしい．
さて，コンパイルする部分の説明はちょっと難しいのでスキップする．もし興味があるなら
コードを読んでみてほしい．
というか正直なところコードを書くのに疲れた．もう寝る．</p>
<div class="section" id="full-code-listing">
<h2>Full code listing<a class="headerlink" href="#full-code-listing" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">ast.ml</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">type</span> <span class="n">ast</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Ref</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="nc">Lam</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="n">ast</span>
  <span class="o">|</span> <span class="nc">App</span> <span class="k">of</span> <span class="n">ast</span> <span class="o">*</span> <span class="n">ast</span>

<span class="k">type</span> <span class="n">stat</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Def</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="n">ast</span>

<span class="k">type</span> <span class="n">indexed_ast</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">IxRef</span>   <span class="k">of</span> <span class="kt">int</span>            <span class="c">(* Index of access to environment *)</span>
  <span class="o">|</span> <span class="nc">IxGRef</span>  <span class="k">of</span> <span class="kt">string</span>         <span class="c">(* External name reference *)</span>
  <span class="o">|</span> <span class="nc">IxLam</span>   <span class="k">of</span>    <span class="kt">int</span>         <span class="c">(* Id of anonymouse function *)</span>
                <span class="o">*</span> <span class="kt">int</span>         <span class="c">(* Index of store to environment *)</span>
                <span class="o">*</span> <span class="n">indexed_ast</span> <span class="c">(* Body of lambda abstraction *)</span>
  <span class="o">|</span> <span class="nc">IxApp</span>   <span class="k">of</span>    <span class="n">indexed_ast</span> <span class="o">*</span> <span class="n">indexed_ast</span>

<span class="k">type</span> <span class="n">indexed_stat</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">IxDef</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="n">indexed_ast</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">index_ast</span> <span class="n">id</span> <span class="n">tbl</span> <span class="n">i</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Ref</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">tbl</span> <span class="n">s</span> <span class="k">in</span> <span class="nc">IxRef</span><span class="o">(</span><span class="n">idx</span><span class="o">)</span>
    <span class="k">with</span>
      <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nc">IxGRef</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">end</span>
  <span class="o">|</span> <span class="nc">Lam</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="n">id&#39;</span> <span class="o">=</span> <span class="o">!</span><span class="n">id</span> <span class="k">in</span> <span class="n">id</span> <span class="o">:=</span> <span class="n">id&#39;</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">tbl</span> <span class="n">s</span> <span class="n">i</span><span class="o">;</span> <span class="nc">IxLam</span><span class="o">(</span><span class="n">id&#39;</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">index_ast</span> <span class="n">id</span> <span class="n">tbl</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">x</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">App</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">IxApp</span><span class="o">(</span><span class="n">index_ast</span> <span class="n">id</span> <span class="n">tbl</span> <span class="n">i</span> <span class="n">x</span><span class="o">,</span> <span class="n">index_ast</span> <span class="n">id</span> <span class="n">tbl</span> <span class="n">i</span> <span class="n">y</span><span class="o">)</span>

<span class="k">let</span> <span class="n">index_stat</span> <span class="n">id</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Def</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">IxDef</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">index_ast</span> <span class="n">id</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">256</span><span class="o">)</span> <span class="mi">0</span> <span class="n">x</span><span class="o">)</span>

<span class="k">let</span> <span class="n">index_stats</span> <span class="n">xs</span> <span class="o">=</span> <span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">index_stat</span> <span class="n">id</span><span class="o">)</span> <span class="n">xs</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">max_index_ast</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">IxRef</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">i</span>
  <span class="o">|</span> <span class="nc">IxGRef</span><span class="o">(_)</span> <span class="o">-&gt;</span> <span class="mi">0</span>
  <span class="o">|</span> <span class="nc">IxLam</span><span class="o">(_,</span> <span class="n">i</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">max</span> <span class="n">i</span> <span class="o">(</span><span class="n">max_index_ast</span> <span class="n">x</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">IxApp</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">max</span> <span class="o">(</span><span class="n">max_index_ast</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">max_index_ast</span> <span class="n">y</span><span class="o">)</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">max_index_stat</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">IxDef</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">max_index_ast</span> <span class="n">x</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">lexer.mll</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">{</span>
<span class="k">open</span> <span class="nc">Parser</span>
<span class="o">}</span>

<span class="n">rule</span> <span class="n">token</span> <span class="o">=</span> <span class="n">parse</span>
  <span class="o">[</span><span class="sc">&#39; &#39;</span> <span class="sc">&#39;\t&#39;</span><span class="o">]</span>            <span class="o">{</span> <span class="n">token</span> <span class="n">lexbuf</span> <span class="o">}</span>
  <span class="o">|</span> <span class="o">[</span><span class="sc">&#39;a&#39;</span><span class="o">-</span><span class="sc">&#39;z&#39;</span> <span class="sc">&#39;A&#39;</span><span class="o">-</span><span class="sc">&#39;Z&#39;</span><span class="o">]</span>   <span class="o">{</span> <span class="nc">IDENT</span><span class="o">(</span><span class="nn">Lexing</span><span class="p">.</span><span class="n">lexeme</span> <span class="n">lexbuf</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;\\&#39;</span>                <span class="o">{</span> <span class="nc">LAMBDA</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;.&#39;</span>                 <span class="o">{</span> <span class="nc">DOT</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;:&#39;</span> <span class="sc">&#39;=&#39;</span>             <span class="o">{</span> <span class="nc">ASSIGN</span> <span class="o">}</span>
  <span class="o">|</span> <span class="o">[</span><span class="sc">&#39;\n&#39;</span><span class="o">]</span>              <span class="o">{</span> <span class="nc">EOL</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;(&#39;</span>                 <span class="o">{</span> <span class="nc">OPEN</span> <span class="o">}</span>
  <span class="o">|</span> <span class="sc">&#39;)&#39;</span>                 <span class="o">{</span> <span class="nc">CLOSE</span> <span class="o">}</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">parser.mly</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">%{</span>

<span class="o">%}</span>

<span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="nc">IDENT</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">LAMBDA</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">DOT</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">ASSIGN</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">EOL</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">OPEN</span>
<span class="o">%</span><span class="n">token</span> <span class="nc">CLOSE</span>
<span class="o">%</span><span class="n">start</span> <span class="n">main</span>
<span class="o">%</span><span class="k">type</span> <span class="o">&lt;</span><span class="nn">Ast</span><span class="p">.</span><span class="n">stat</span> <span class="kt">list</span><span class="o">&gt;</span> <span class="n">main</span>

<span class="o">%%</span>

<span class="n">main</span><span class="o">:</span>
    <span class="nc">EOL</span>           <span class="o">{</span> <span class="bp">[]</span> <span class="o">}</span>
  <span class="o">|</span> <span class="n">stat</span> <span class="nc">EOL</span> <span class="n">main</span> <span class="o">{</span> <span class="o">$</span><span class="mi">1</span> <span class="o">::</span> <span class="o">$</span><span class="mi">3</span> <span class="o">}</span>

<span class="n">gident</span><span class="o">:</span>
    <span class="nc">IDENT</span>         <span class="o">{</span> <span class="o">$</span><span class="mi">1</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">IDENT</span> <span class="n">gident</span>  <span class="o">{</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">[$</span><span class="mi">1</span><span class="o">;</span> <span class="o">$</span><span class="mi">2</span><span class="o">]</span> <span class="o">}</span>

<span class="n">stat</span><span class="o">:</span>
    <span class="n">gident</span> <span class="nc">ASSIGN</span> <span class="n">expr</span>  <span class="o">{</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">Def</span><span class="o">($</span><span class="mi">1</span><span class="o">,</span> <span class="o">$</span><span class="mi">3</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="n">gident</span> <span class="nc">ASSIGN</span> <span class="n">app</span>   <span class="o">{</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">Def</span><span class="o">($</span><span class="mi">1</span><span class="o">,</span> <span class="o">$</span><span class="mi">3</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="n">gident</span> <span class="nc">ASSIGN</span> <span class="n">lam</span>   <span class="o">{</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">Def</span><span class="o">($</span><span class="mi">1</span><span class="o">,</span> <span class="o">$</span><span class="mi">3</span><span class="o">)</span> <span class="o">}</span>

<span class="n">expr</span><span class="o">:</span>
    <span class="n">ref</span> <span class="o">{</span> <span class="o">$</span><span class="mi">1</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">OPEN</span> <span class="n">app</span> <span class="nc">CLOSE</span> <span class="o">{</span> <span class="o">$</span><span class="mi">2</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">OPEN</span> <span class="n">lam</span> <span class="nc">CLOSE</span> <span class="o">{</span> <span class="o">$</span><span class="mi">2</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">OPEN</span> <span class="n">expr</span> <span class="nc">CLOSE</span> <span class="o">{</span> <span class="o">$</span><span class="mi">2</span> <span class="o">}</span>

<span class="n">ref</span><span class="o">:</span>
    <span class="nc">IDENT</span> <span class="o">{</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">Ref</span><span class="o">($</span><span class="mi">1</span><span class="o">)</span> <span class="o">}</span>

<span class="n">lam</span><span class="o">:</span>
    <span class="nc">LAMBDA</span> <span class="n">param_list</span> <span class="nc">DOT</span> <span class="n">expr</span> <span class="o">{</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">Lam</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">))</span> <span class="o">$</span><span class="mi">2</span> <span class="o">$</span><span class="mi">4</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">LAMBDA</span> <span class="n">param_list</span> <span class="nc">DOT</span> <span class="n">app</span>  <span class="o">{</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">Lam</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">))</span> <span class="o">$</span><span class="mi">2</span> <span class="o">$</span><span class="mi">4</span> <span class="o">}</span>

<span class="n">param_list</span><span class="o">:</span>
    <span class="nc">IDENT</span> <span class="o">{</span> <span class="o">[$</span><span class="mi">1</span><span class="o">]</span> <span class="o">}</span>
  <span class="o">|</span> <span class="nc">IDENT</span> <span class="n">param_list</span> <span class="o">{</span> <span class="o">$</span><span class="mi">1</span> <span class="o">::</span> <span class="o">$</span><span class="mi">2</span> <span class="o">}</span>

<span class="n">app</span><span class="o">:</span>
    <span class="n">expr</span> <span class="n">expr</span> <span class="o">{</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">App</span><span class="o">($</span><span class="mi">1</span><span class="o">,</span> <span class="o">$</span><span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
  <span class="o">|</span> <span class="n">app</span> <span class="n">expr</span>  <span class="o">{</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">App</span><span class="o">($</span><span class="mi">1</span><span class="o">,</span> <span class="o">$</span><span class="mi">2</span><span class="o">)</span> <span class="o">}</span>

<span class="o">%%</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">lambda.ml</p>
<div class="highlight-ocaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">open</span> <span class="nc">Llvm</span>

<span class="c">(*==... Read code from stdin ...............................................==*)</span>
<span class="k">let</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lexbuf</span> <span class="o">=</span> <span class="nn">Lexing</span><span class="p">.</span><span class="n">from_channel</span> <span class="n">stdin</span> <span class="k">in</span>
  <span class="nn">Parser</span><span class="p">.</span><span class="n">main</span> <span class="nn">Lexer</span><span class="p">.</span><span class="n">token</span> <span class="n">lexbuf</span>

<span class="c">(*==... building LLVM ......................................................==*)</span>
<span class="k">let</span> <span class="n">context</span> <span class="o">=</span> <span class="n">global_context</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">lambda_module</span> <span class="o">=</span> <span class="n">create_module</span> <span class="n">context</span> <span class="s2">&quot;lambda&quot;</span>
<span class="k">let</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span> <span class="n">context</span>

<span class="c">(*--... types ..............................................................--*)</span>
<span class="k">let</span> <span class="n">void_t</span> <span class="o">=</span> <span class="n">void_type</span> <span class="n">context</span>
<span class="k">let</span> <span class="n">i8_t</span> <span class="o">=</span> <span class="n">i8_type</span> <span class="n">context</span>
<span class="k">let</span> <span class="n">i32_t</span> <span class="o">=</span> <span class="n">i32_type</span> <span class="n">context</span>
<span class="k">let</span> <span class="n">lambda_t</span> <span class="o">=</span> <span class="n">function_type</span> <span class="n">void_t</span> <span class="o">[||]</span>
<span class="k">let</span> <span class="n">val_t</span> <span class="o">=</span> <span class="n">pointer_type</span> <span class="o">(</span><span class="n">struct_type</span> <span class="n">context</span> <span class="o">[|</span> <span class="n">pointer_type</span> <span class="n">i8_t</span><span class="o">;</span> <span class="n">pointer_type</span> <span class="n">lambda_t</span> <span class="o">|])</span>

<span class="c">(* Count of lambda abstraction *)</span>
<span class="c">(*let abs_count = List.fold_right (fun x i -&gt; i + Ast.abs_count_stat x) x 0*)</span>

<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">Ast</span><span class="p">.</span><span class="n">index_stats</span> <span class="n">x</span>

<span class="k">let</span> <span class="n">max_index</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">max</span> <span class="n">i</span> <span class="o">(</span><span class="nn">Ast</span><span class="p">.</span><span class="n">max_index_stat</span> <span class="n">x</span><span class="o">))</span> <span class="n">x</span> <span class="mi">0</span>

<span class="k">let</span> <span class="n">stack_t</span>     <span class="o">=</span> <span class="n">array_type</span> <span class="n">val_t</span> <span class="mi">256</span>
<span class="k">let</span> <span class="n">stack_ptr_t</span> <span class="o">=</span> <span class="n">pointer_type</span> <span class="n">i32_t</span>
<span class="k">let</span> <span class="n">env_t</span>       <span class="o">=</span> <span class="n">array_type</span> <span class="n">val_t</span> <span class="o">(</span><span class="n">max_index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">env_stack_t</span> <span class="o">=</span> <span class="n">array_type</span> <span class="o">(</span><span class="n">pointer_type</span> <span class="n">env_t</span><span class="o">)</span> <span class="mi">256</span>

<span class="c">(*--... global variables ...................................................--*)</span>
<span class="k">let</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">define_global</span> <span class="s2">&quot;.stack&quot;</span> <span class="o">(</span><span class="n">const_array</span>
                                    <span class="n">val_t</span>
                                    <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span>
                                        <span class="mi">256</span>
                                        <span class="o">(</span><span class="n">const_struct</span>
                                            <span class="n">context</span>
                                            <span class="o">[||])))</span> <span class="n">lambda_module</span>

<span class="k">let</span> <span class="n">stack_ptr</span> <span class="o">=</span> <span class="n">define_global</span> <span class="s2">&quot;.stack_ptr&quot;</span> <span class="o">(</span><span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">0</span><span class="o">)</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">env</span> <span class="o">=</span> <span class="n">define_global</span> <span class="s2">&quot;.env&quot;</span> <span class="o">(</span><span class="n">const_pointer_null</span> <span class="o">(</span><span class="n">pointer_type</span> <span class="n">env_t</span><span class="o">))</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">env_stack_ptr</span> <span class="o">=</span> <span class="n">define_global</span> <span class="s2">&quot;.env_stack_ptr&quot;</span> <span class="o">(</span><span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">0</span><span class="o">)</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">env_stack</span> <span class="o">=</span> <span class="n">define_global</span> <span class="s2">&quot;.env_stack&quot;</span> <span class="o">(</span><span class="n">const_array</span>
                                        <span class="o">(</span><span class="n">pointer_type</span> <span class="n">env_t</span><span class="o">)</span>
                                        <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span>
                                            <span class="mi">256</span>
                                            <span class="o">(</span><span class="n">const_struct</span>
                                                <span class="n">context</span>
                                                <span class="o">[||])))</span> <span class="n">lambda_module</span>

<span class="c">(*--... system functions ...................................................--*)</span>
<span class="k">let</span> <span class="n">stack_push</span>  <span class="o">=</span> <span class="n">declare_function</span> <span class="s2">&quot;stack_push&quot;</span> <span class="o">(</span><span class="n">function_type</span> <span class="n">void_t</span> <span class="o">[|</span> <span class="n">val_t</span> <span class="o">|])</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">stack_pop</span>   <span class="o">=</span> <span class="n">declare_function</span> <span class="s2">&quot;stack_pop&quot;</span> <span class="o">(</span><span class="n">function_type</span> <span class="n">val_t</span> <span class="o">[||])</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">env_reset</span>   <span class="o">=</span> <span class="n">declare_function</span> <span class="s2">&quot;env_reset&quot;</span> <span class="o">(</span><span class="n">function_type</span> <span class="n">void_t</span> <span class="o">[||])</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">env_access</span>  <span class="o">=</span> <span class="n">declare_function</span> <span class="s2">&quot;env_access&quot;</span> <span class="o">(</span><span class="n">function_type</span> <span class="n">val_t</span> <span class="o">[|</span> <span class="n">i32_t</span> <span class="o">|])</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">env_assign</span>  <span class="o">=</span> <span class="n">declare_function</span> <span class="s2">&quot;env_assign&quot;</span> <span class="o">(</span><span class="n">function_type</span> <span class="n">void_t</span> <span class="o">[|</span> <span class="n">i32_t</span><span class="o">;</span> <span class="n">val_t</span> <span class="o">|])</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">estack_push</span> <span class="o">=</span> <span class="n">declare_function</span> <span class="s2">&quot;env_stack_push&quot;</span> <span class="o">(</span><span class="n">function_type</span> <span class="n">void_t</span> <span class="o">[|</span> <span class="n">pointer_type</span> <span class="n">env_t</span> <span class="o">|])</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">estack_pop</span>  <span class="o">=</span> <span class="n">declare_function</span> <span class="s2">&quot;env_stack_pop&quot;</span> <span class="o">(</span><span class="n">function_type</span> <span class="o">(</span><span class="n">pointer_type</span> <span class="n">env_t</span><span class="o">)</span> <span class="o">[||])</span> <span class="n">lambda_module</span>
<span class="k">let</span> <span class="n">app</span>         <span class="o">=</span> <span class="n">declare_function</span> <span class="s2">&quot;app&quot;</span>  <span class="o">(</span><span class="n">function_type</span> <span class="n">void_t</span> <span class="o">[||])</span> <span class="n">lambda_module</span>

<span class="c">(*--... implementations of system functions ................................--*)</span>
<span class="c">(* implementation of stack_push is in lambda.ll *)</span>
<span class="c">(* implementation of stack_pop is in lambda.ll *)</span>
<span class="c">(*--... implementation of env_reset ........................................--*)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">begin</span>
  <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">append_block</span> <span class="n">context</span> <span class="s2">&quot;entry&quot;</span> <span class="n">env_reset</span> <span class="k">in</span>
  <span class="n">position_at_end</span> <span class="n">pos</span> <span class="n">builder</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">env_init</span> <span class="o">=</span> <span class="n">build_malloc</span> <span class="n">env_t</span> <span class="s2">&quot;env&quot;</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_store</span> <span class="n">env_init</span> <span class="n">env</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_ret_void</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="bp">()</span>
<span class="k">end</span>
<span class="c">(* implementation of env_access is in lambda.ll *)</span>
<span class="c">(* implementation of env_assign is in lambda.ll *)</span>
<span class="c">(*--... implementation of estack_push ......................................--*)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">begin</span>
  <span class="k">match</span> <span class="n">params</span> <span class="n">estack_push</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">[|</span> <span class="n">env</span> <span class="o">|]</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">append_block</span> <span class="n">context</span> <span class="s2">&quot;entry&quot;</span> <span class="n">estack_push</span> <span class="k">in</span>
      <span class="n">position_at_end</span> <span class="n">pos</span> <span class="n">builder</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">env_stack_ptr&#39;</span> <span class="o">=</span> <span class="n">build_load</span> <span class="n">env_stack_ptr</span> <span class="s2">&quot;env_stack_ptr&quot;</span> <span class="n">builder</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">new_env_stack_ptr</span> <span class="o">=</span> <span class="n">build_add</span> <span class="n">env_stack_ptr&#39;</span> <span class="o">(</span><span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">1</span><span class="o">)</span> <span class="s2">&quot;new_env_stack_ptr&quot;</span> <span class="n">builder</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">env_stack_head</span> <span class="o">=</span> <span class="n">build_in_bounds_gep</span> <span class="n">env_stack</span> <span class="o">[|</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">0</span><span class="o">;</span> <span class="n">new_env_stack_ptr</span> <span class="o">|]</span> <span class="s2">&quot;env_stack_head&quot;</span>  <span class="n">builder</span> <span class="k">in</span>
      <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_store</span> <span class="n">new_env_stack_ptr</span> <span class="n">env_stack_ptr</span> <span class="n">builder</span> <span class="k">in</span>
      <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_store</span> <span class="n">env</span> <span class="n">env_stack_head</span> <span class="n">builder</span> <span class="k">in</span>
      <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_ret_void</span> <span class="n">builder</span> <span class="k">in</span>
      <span class="bp">()</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>
<span class="k">end</span>
<span class="c">(*--... implementation of estack_pop .......................................--*)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">begin</span>
  <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">append_block</span> <span class="n">context</span> <span class="s2">&quot;entry&quot;</span> <span class="n">estack_pop</span> <span class="k">in</span>
  <span class="n">position_at_end</span> <span class="n">pos</span> <span class="n">builder</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">env_stack_ptr&#39;</span> <span class="o">=</span> <span class="n">build_load</span> <span class="n">env_stack_ptr</span> <span class="s2">&quot;env_stack_ptr&quot;</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">new_env_stack_ptr</span> <span class="o">=</span> <span class="n">build_sub</span> <span class="n">env_stack_ptr&#39;</span> <span class="o">(</span><span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">1</span><span class="o">)</span> <span class="s2">&quot;new_env_stack_ptr&quot;</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">env_stack_head</span> <span class="o">=</span> <span class="n">build_in_bounds_gep</span> <span class="n">env_stack</span> <span class="o">[|</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">0</span><span class="o">;</span> <span class="n">env_stack_ptr&#39;</span> <span class="o">|]</span> <span class="s2">&quot;env_stack_head&quot;</span>  <span class="n">builder</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">build_load</span> <span class="n">env_stack_head</span> <span class="s2">&quot;env&quot;</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_store</span> <span class="n">new_env_stack_ptr</span> <span class="n">env_stack_ptr</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_store</span> <span class="o">(</span><span class="n">const_pointer_null</span> <span class="o">(</span><span class="n">pointer_type</span> <span class="n">env_t</span><span class="o">))</span> <span class="n">env_stack_head</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_ret</span> <span class="n">v</span> <span class="n">builder</span> <span class="k">in</span>
  <span class="bp">()</span>
<span class="k">end</span>
<span class="c">(* implementation of app is in lambda.ll *)</span>

<span class="c">(*--... code generation for lambda abstraction .............................--*)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">abs_gen_ast</span> <span class="n">prefix</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">IxRef</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="n">build_call</span> <span class="n">env_access</span> <span class="o">[|</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="n">i</span> <span class="o">|]</span> <span class="s2">&quot;val&quot;</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="k">let</span> <span class="o">_</span>     <span class="o">=</span> <span class="n">build_call</span> <span class="n">stack_push</span> <span class="o">[|</span> <span class="k">value</span> <span class="o">|]</span> <span class="s2">&quot;&quot;</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="bp">()</span>
  <span class="o">|</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">IxGRef</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">declare_function</span> <span class="n">s</span> <span class="n">lambda_t</span> <span class="n">lambda_module</span> <span class="k">in</span>
    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_call</span> <span class="n">fn</span> <span class="o">[||]</span> <span class="s2">&quot;&quot;</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="bp">()</span>
  <span class="o">|</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">IxApp</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="n">abs_gen_ast</span> <span class="n">prefix</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">abs_gen_ast</span> <span class="n">prefix</span> <span class="n">x</span><span class="o">;</span>
    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_call</span> <span class="n">app</span> <span class="o">[||]</span> <span class="s2">&quot;&quot;</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="bp">()</span>
  <span class="o">|</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">IxLam</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">-&gt;</span>

    <span class="c">(* Make a lambda returning *)</span>
    <span class="k">let</span> <span class="n">closure</span> <span class="o">=</span> <span class="n">build_malloc</span> <span class="o">(</span><span class="n">struct_type</span> <span class="n">context</span> <span class="o">[|</span> <span class="n">pointer_type</span> <span class="n">i8_t</span><span class="o">;</span> <span class="n">pointer_type</span> <span class="n">lambda_t</span> <span class="o">|])</span> <span class="s2">&quot;closure&quot;</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">env_ptr</span> <span class="o">=</span> <span class="n">build_in_bounds_gep</span> <span class="n">closure</span> <span class="o">[|</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">0</span><span class="o">;</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">0</span><span class="o">;</span> <span class="o">|]</span> <span class="s2">&quot;env_ptr&quot;</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">fn_ptr</span> <span class="o">=</span> <span class="n">build_in_bounds_gep</span> <span class="n">closure</span> <span class="o">[|</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">0</span><span class="o">;</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">1</span><span class="o">;</span> <span class="o">|]</span> <span class="s2">&quot;fn_ptr&quot;</span> <span class="n">builder</span> <span class="k">in</span>

    <span class="k">let</span> <span class="n">env_cpy</span> <span class="o">=</span> <span class="n">build_malloc</span> <span class="n">env_t</span> <span class="s2">&quot;env_cpy&quot;</span> <span class="n">builder</span> <span class="k">in</span>

    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">max_index</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">build_call</span> <span class="n">env_access</span> <span class="o">[|</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="n">i</span> <span class="o">|]</span> <span class="s2">&quot;x&quot;</span> <span class="n">builder</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">y</span> <span class="o">=</span> <span class="n">build_in_bounds_gep</span> <span class="n">env_cpy</span> <span class="o">[|</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="mi">0</span><span class="o">;</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="n">i</span> <span class="o">|]</span> <span class="s2">&quot;y&quot;</span> <span class="n">builder</span> <span class="k">in</span>
      <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_store</span> <span class="n">x</span> <span class="n">y</span> <span class="n">builder</span> <span class="k">in</span>
      <span class="bp">()</span>
    <span class="k">done</span><span class="o">;</span>

    <span class="k">let</span> <span class="n">env_cpy</span> <span class="o">=</span> <span class="n">build_pointercast</span> <span class="n">env_cpy</span> <span class="o">(</span><span class="n">pointer_type</span> <span class="n">i8_t</span><span class="o">)</span> <span class="s2">&quot;env_cpy&quot;</span> <span class="n">builder</span> <span class="k">in</span>

    <span class="k">let</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">declare_function</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">;</span> <span class="n">prefix</span><span class="o">;</span> <span class="s2">&quot;.anon_func.&quot;</span><span class="o">;</span> <span class="n">string_of_int</span> <span class="n">id</span><span class="o">])</span> <span class="n">lambda_t</span> <span class="n">lambda_module</span> <span class="k">in</span>

    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_store</span> <span class="n">env_cpy</span> <span class="n">env_ptr</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_store</span> <span class="n">fn</span> <span class="n">fn_ptr</span> <span class="n">builder</span> <span class="k">in</span>

    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_call</span> <span class="n">stack_push</span> <span class="o">[|</span> <span class="n">closure</span> <span class="o">|]</span> <span class="s2">&quot;&quot;</span> <span class="n">builder</span> <span class="k">in</span>

    <span class="n">set_linkage</span> <span class="nn">Linkage</span><span class="p">.</span><span class="nc">Private</span> <span class="n">fn</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">append_block</span> <span class="n">context</span> <span class="s2">&quot;entry&quot;</span> <span class="n">fn</span> <span class="k">in</span>
    <span class="n">position_at_end</span> <span class="n">pos</span> <span class="n">builder</span><span class="o">;</span>

    <span class="c">(* Take an argument from stack *)</span>
    <span class="k">let</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">build_call</span> <span class="n">stack_pop</span> <span class="o">[||]</span> <span class="s2">&quot;arg&quot;</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_call</span> <span class="n">env_assign</span> <span class="o">[|</span> <span class="n">const_int</span> <span class="n">i32_t</span> <span class="n">i</span><span class="o">;</span> <span class="n">arg</span> <span class="o">|]</span> <span class="s2">&quot;&quot;</span> <span class="n">builder</span> <span class="k">in</span>

    <span class="n">abs_gen_ast</span> <span class="n">prefix</span> <span class="n">x</span><span class="o">;</span>
    <span class="n">position_at_end</span> <span class="n">pos</span> <span class="n">builder</span><span class="o">;</span>
    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_ret_void</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="bp">()</span>

<span class="k">let</span> <span class="n">abs_gen_stat</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nn">Ast</span><span class="p">.</span><span class="nc">IxDef</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">declare_function</span> <span class="n">s</span> <span class="n">lambda_t</span> <span class="n">lambda_module</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">append_block</span> <span class="n">context</span> <span class="s2">&quot;entry&quot;</span> <span class="n">f</span> <span class="k">in</span>
    <span class="n">position_at_end</span> <span class="n">pos</span> <span class="n">builder</span><span class="o">;</span>
    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_call</span> <span class="n">env_reset</span> <span class="o">[||]</span> <span class="s2">&quot;&quot;</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="n">abs_gen_ast</span> <span class="n">s</span> <span class="n">x</span><span class="o">;</span>
    <span class="n">position_at_end</span> <span class="n">pos</span> <span class="n">builder</span><span class="o">;</span>
    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">build_ret_void</span> <span class="n">builder</span> <span class="k">in</span>
    <span class="bp">()</span>

<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">abs_gen_stat</span> <span class="n">x</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">dump_module</span> <span class="n">lambda_module</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">lambda.ll</p>
<div class="highlight-llvm"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span class="vg">@.stack</span> <span class="p">=</span> <span class="k">external</span> <span class="k">global</span> <span class="p">[</span><span class="m">256</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]</span>
<span class="vg">@.stack_ptr</span> <span class="p">=</span> <span class="k">external</span> <span class="k">global</span> <span class="k">i32</span>
<span class="vg">@.env</span> <span class="p">=</span> <span class="k">external</span> <span class="k">global</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span>

<span class="k">define</span> <span class="kt">void</span> <span class="vg">@stack_push</span><span class="p">({</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*)</span> <span class="p">{</span>
<span class="nl">entry:</span>
  <span class="nv">%stack_ptr</span> <span class="p">=</span> <span class="k">load</span> <span class="k">i32</span><span class="p">*</span> <span class="vg">@.stack_ptr</span>
  <span class="nv">%new_stack_ptr</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i32</span> <span class="nv">%stack_ptr</span><span class="p">,</span> <span class="m">1</span>
  <span class="k">store</span> <span class="k">i32</span> <span class="nv">%new_stack_ptr</span><span class="p">,</span> <span class="k">i32</span><span class="p">*</span> <span class="vg">@.stack_ptr</span>
  <span class="nv">%stack_head</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">256</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="vg">@.stack</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span> <span class="nv">%new_stack_ptr</span>
  <span class="k">store</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="nv-Anonymous">%0</span><span class="p">,</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}**</span> <span class="nv">%stack_head</span>
  <span class="k">ret</span> <span class="kt">void</span>
<span class="p">}</span>

<span class="k">define</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="vg">@stack_pop</span><span class="p">()</span> <span class="p">{</span>
<span class="nl">entry:</span>
  <span class="nv">%stack_ptr</span> <span class="p">=</span> <span class="k">load</span> <span class="k">i32</span><span class="p">*</span> <span class="vg">@.stack_ptr</span>
  <span class="nv">%stack_head</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">256</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="vg">@.stack</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span> <span class="nv">%stack_ptr</span>
  <span class="nv">%val</span> <span class="p">=</span> <span class="k">load</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}**</span> <span class="nv">%stack_head</span>
  <span class="nv">%new_stack_ptr</span> <span class="p">=</span> <span class="k">sub</span> <span class="k">i32</span> <span class="nv">%stack_ptr</span><span class="p">,</span> <span class="m">1</span>
  <span class="k">store</span> <span class="k">i32</span> <span class="nv">%new_stack_ptr</span><span class="p">,</span> <span class="k">i32</span><span class="p">*</span> <span class="vg">@.stack_ptr</span>
  <span class="k">store</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="k">null</span><span class="p">,</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}**</span> <span class="nv">%stack_head</span>
  <span class="k">ret</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="nv">%val</span>
<span class="p">}</span>

<span class="k">define</span> <span class="kt">void</span> <span class="vg">@env_assign</span><span class="p">(</span><span class="k">i32</span><span class="p">,</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*)</span> <span class="p">{</span>
<span class="nl">entry:</span>
  <span class="nv">%env</span> <span class="p">=</span> <span class="k">load</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]**</span> <span class="vg">@.env</span>
  <span class="nv">%x</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="nv">%env</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span> <span class="nv-Anonymous">%0</span>
  <span class="k">store</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="nv-Anonymous">%1</span><span class="p">,</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}**</span> <span class="nv">%x</span>
  <span class="k">ret</span> <span class="kt">void</span>
<span class="p">}</span>

<span class="k">define</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="vg">@env_access</span><span class="p">(</span><span class="k">i32</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">entry:</span>
  <span class="nv">%env</span> <span class="p">=</span> <span class="k">load</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]**</span> <span class="vg">@.env</span>
  <span class="nv">%x</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="nv">%env</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span> <span class="nv-Anonymous">%0</span>
  <span class="nv">%x1</span> <span class="p">=</span> <span class="k">load</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}**</span> <span class="nv">%x</span>
  <span class="k">ret</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="nv">%x1</span>
<span class="p">}</span>

<span class="k">declare</span> <span class="kt">void</span> <span class="vg">@env_stack_push</span><span class="p">([</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*)</span>

<span class="k">declare</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="vg">@env_stack_pop</span><span class="p">()</span>

<span class="k">define</span> <span class="kt">void</span> <span class="vg">@app</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">%closure</span> <span class="p">=</span> <span class="k">call</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="vg">@stack_pop</span><span class="p">()</span>
  <span class="nv">%old_env</span> <span class="p">=</span> <span class="k">load</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]**</span> <span class="vg">@.env</span>
  <span class="k">call</span> <span class="kt">void</span> <span class="vg">@env_stack_push</span><span class="p">([</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="nv">%old_env</span><span class="p">)</span>
  <span class="nv">%env_ptr</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="nv">%closure</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span>
  <span class="nv">%env</span> <span class="p">=</span> <span class="k">load</span> <span class="k">i8</span><span class="p">**</span> <span class="nv">%env_ptr</span>
  <span class="nv">%env1</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="k">i8</span><span class="p">*</span> <span class="nv">%env</span> <span class="k">to</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span>
  <span class="nv">%fn_ptr</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*</span> <span class="nv">%closure</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span> <span class="m">1</span>
  <span class="nv">%fn</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">void</span> <span class="p">()**</span> <span class="nv">%fn_ptr</span>
  <span class="k">store</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="nv">%env1</span><span class="p">,</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]**</span> <span class="vg">@.env</span>
  <span class="k">call</span> <span class="kt">void</span> <span class="nv">%fn</span><span class="p">()</span>
  <span class="nv">%ret_env</span> <span class="p">=</span> <span class="k">call</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="vg">@env_stack_pop</span><span class="p">()</span>
  <span class="k">store</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]*</span> <span class="nv">%ret_env</span><span class="p">,</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="kt">void</span> <span class="p">()*</span> <span class="p">}*]**</span> <span class="vg">@.env</span>
  <span class="k">ret</span> <span class="kt">void</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">ski.txt</p>
<div class="highlight-none"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre>S := \xyz.xz(yz)
K := \xy.x
I := SKK
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">test.c</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="kt">val_t</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="kt">val_t</span> <span class="o">**</span><span class="n">env</span><span class="p">;</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="p">}</span> <span class="o">*</span><span class="kt">val_t</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">stack_push</span><span class="p">(</span><span class="kt">val_t</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">val_t</span> <span class="nf">stack_pop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">env_assign</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">val_t</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">val_t</span> <span class="nf">env_access</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">env_stack_push</span><span class="p">(</span><span class="kt">val_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">val_t</span> <span class="o">*</span><span class="nf">env_stack_pop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">app</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">S</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">K</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">I</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">stack_push</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
    <span class="n">I</span><span class="p">();</span>
    <span class="n">app</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">stack_pop</span><span class="p">();</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">OMakefile</p>
<div class="highlight-none"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre>open build/OCaml

USE_OCAMLFIND = true

OCAMLPACKS[] =
  llvm

OCamlProgram(lambda, lambda parser lexer ast)
OCamlGeneratedFiles(parser.ml lexer.ml)

test.ll: test.c
  clang test.c -S -emit-llvm -o test.ll

ski.ll: ski.txt lambda
  sh -c &quot;./lambda &lt; ski.txt 2&gt; ski.ll&quot;

main.ll: test.ll lambda.ll ski.ll
  llvm-link -S lambda.ll ski.ll test.ll -o main.ll

main.o: main.ll
  llc -filetype obj main.ll

a.out: main.o
  gcc main.o
</pre></div>
</td></tr></table></div>
</li>
</ul>
</div>
</div>


    </div>

</body>
</html>